<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link href="https://github.com/Lcfvs/esmb/blob/gh-pages/LICENSE" rel="license">
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
  <title>esmb editor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/codemirror.min.css"
        integrity="sha512-9VgBnmEYUpZ041Fz5LvsEsFlEzAlUw6Ku5uPhNSKgqY4DgM+g8BRoYvfbfDcTqs3BPsREBB3ccVVlkCSLZ5T+Q=="
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/dialog/dialog.min.css"
        integrity="sha512-Vogm+Cii1SXP5oxWQyPdkA91rHB776209ZVvX4C/i4ypcfBlWVRXZGodoTDAyyZvO36JlTqDqkMhVKAYc7CMjQ=="
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/hint/show-hint.min.css"
        integrity="sha512-OmcLQEy8iGiD7PSm85s06dnR7G7C9C0VqahIPAj/KHk5RpOCmnC6R2ob1oK4/uwYhWa9BF1GC6tzxsC8TIx7Jg=="
        crossorigin="anonymous">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/scroll/simplescrollbars.min.css"
        integrity="sha512-2y3NTsei81d5emn5nwrdflyI5EGULwKXRZ0BCbO55cjgQ8x62X4ydH/jbnzrKnxArstf79F9n6z1j2MtVmJ8YA=="
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/tern/tern.min.css"
        integrity="sha512-1sgoyWh9WoZ2BVDuNqKPZPyr5IP1x2UOEF64cCtm6lOTCqCpWb30EyjWHR/vypopSdIVJ/dfabYRPAO+gXbviQ=="
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/theme/moxer.min.css"
        media="(prefers-color-scheme: dark)"
        integrity="sha512-zrCGHGmTpiZpzVJ6BdiDfsUT6t8+oOKmOtfU82GhBo/7sk/cns7phhKXSWmGH6uACPqgjP8QmgczNBY7HMB9TQ=="
        crossorigin="anonymous">
  <style>
      body > header {
          position: fixed;
          background-color: transparent;
          top: 0.5em;
          left: 0.5em;
          z-index: 9999;
      }
      body > header > button {
          height: 1.5em;
          background-color: #c2c6d6;
      }
      body > textarea, body > .CodeMirror {
          position: fixed;
          width: 100vw;
          height: calc(100vh - 3em);
          left: 0;
          top: 0;
          padding-top: 3em
      }
      body > .CodeMirror-Tern-tooltip {
          margin-top: -1.5em;
          margin-left: 1em;
      }
      body > .CodeMirror.cm-s-moxer ~ .CodeMirror-Tern-tooltip {
          margin-top: -1.8em;
      }
      body > .CodeMirror-hints.moxer {
          background-color: #090a0f;
      }
      body > .CodeMirror-hints.moxer li {
          color: #c2c6d6;
      }
      body > .CodeMirror-hints.moxer .CodeMirror-hint-active {
          color: #f3f4f7;
      }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/codemirror.min.js"
          integrity="sha512-vEtV6ymm5qJIMeVd4oc8U+hCYMYDr7zksWF7xAFghGCfpUZh/Ht5lqAALPn1kixhsMLUTji4pycQB01ZuEPZtQ=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/hint/show-hint.min.js"
          integrity="sha512-A53oruUE1OW/W2aXz3qNaetlBZrxrNIIPa+QWVMklvC9L0QOtrJ4H9HvZU4rmZxaZf01gmCMcUYaTrKZCPgS9w=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.59.4/addon/hint/javascript-hint.min.js"
          integrity="sha512-2zi+0HSB5MXoy+BenDX/EKjqN6eUnsG2Lh9cpx+Ckua3Yi2XupO8ife9VELSg8iR7AT98yHQNyyaAL4ImVHcoQ=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/mode/javascript/javascript.min.js"
          integrity="sha512-uJ2+YVBA3413of09m7nGj0GeNquSQvHlGS9kx12CQg4wiFO8b81lfaBifN8zicYMQ/eGag8UJR/IFXl9ByJ8nA=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/hint/javascript-hint.min.js"
          integrity="sha512-DpK50CnHKO+aTBvBlTDIcEjdhMeaa/zXk8/7Y/Swyc93YCkRuGMJFXxluwvtS3SUFcF47r8j73yPpuSdI+nyqw=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/scroll/simplescrollbars.min.js"
          integrity="sha512-xfrhnaAbPQbVlhM55XyecPDoR+13SnnMGmyNTJ6YthlR5Q8AbaVZYl7iRRCc+Na3lh4CeiI3aaOpBkCYBrDg0w=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/dialog/dialog.min.js"
          integrity="sha512-sSpH/jVpLw4soNP/LN5k/m8yP28nkrqPboPL0DYw+HreBXQS9Q/HYjPqsS2zHs/TDfqowQWEWdZMnRV5uoJbSg=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/display/autorefresh.min.js"
          integrity="sha512-vAsKB7xXQAWMn5kcwda0HkFVKUxSYwrmrGprVhmbGFNAG1Ij+2epT3zzdwjHTJyDsKXsiEdrUdhIxh7loHyX+A=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/display/placeholder.min.js"
          integrity="sha512-5wzKjbvsq0uPbtmQ1/91r9MMGXOOtytkl5XCjjjnlq+rSw5/MF/r7XifwoR1inw9zYAzOncOxoHz4yu14vdMRA=="
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/edit/closebrackets.min.js"
          integrity="sha384-wlumdMCmq3l9EevZhZTkk2ve71CKdAO/rv5CW696xAAi4ttOQUGzCgC7Gk3scAd/"
          crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.50.2/addon/tern/tern.min.js"
          integrity="sha512-kwLy/MXJWYaJ4IRr2tLQC3XprCo2k0oT09y9I8aD5eiJ18uJ6rqlYvoevyVxRM+PiMBUXfTZolmH5Fe9UDE1Fg=="
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/acorn@8.1.0/dist/acorn.js"
          integrity="sha384-N930ALA+9Tts2naebDdEuEtUn5srlZqSlzL2en2rckTNBYQ/N0N1ITZWHVv17Y/a"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/acorn-loose@8.0.2/dist/acorn-loose.js"
          integrity="sha384-oU46fNwM9M9nU30eEYX/HMvyrmK9gGxS082m/igVJ1yMMKbzt4sKu3xxhHHUdT1N"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/acorn-walk@8.0.2/dist/walk.js"
          integrity="sha384-1J4FYqzzIU/LUK/yudmKwXxyitDM8UNkkGTNltMYJAIL8IZwSCmRdaQRgt6zed4c"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/lib/signal.js"
          integrity="sha384-LthBasZX8Wo1XxiI6NxQX79j6o1ZI4Ltr8d6qvE0GZP5mipY5GHszi3V80i/LhAb"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/lib/tern.js"
          integrity="sha384-OMxDt97ZxHVTGbvS9FONVaaK8v0X4T0tpSA9no9b3KkvOIapVqf4DyfGP3ECEka7"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/lib/def.js"
          integrity="sha384-kz7mSFfUVUCN/P/NwAmmICxQmw6ZSfeaIlTOMLs0AS7MLyh8TK7YuB2I51F/L0PG"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/lib/comment.js"
          integrity="sha384-bk1DCNzqlOU5aSOICdVgcz4GDNKZUhGYubeC66t52CmKqViD24yvhL/SY92tpW15"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/lib/infer.js"
          integrity="sha384-0t9yQOvI4dPvJ5ZSOPtzpNKGWIxAu1F9V0tbGoMqHomOM8vUrESyQQGq9qn6CXaU"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/plugin/doc_comment.js"
          integrity="sha384-DgdIGlkl54Ge0a7RGIOjix9Re6ph2gEEWTpccRHtBurEYxLZDruSnbvkDzulmNIn"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/plugin/modules.js"
          integrity="sha384-/uMFlC3hTgE1nE3AorIj6T28DI8nuU2whREWaknRbY7yrDgBlCAEC4daTuyhIh1Y"
          crossorigin="anonymous"></script>
  <script src="https://unpkg.com/tern@0.24.3/plugin/es_modules.js"
          integrity="sha384-48wmVu7ajZ699kBoNPBBHn4k5LHlNeMZi7ZJ17CqgI+etiljns0qkt6KGSJdyLeS"
          crossorigin="anonymous"></script>
  <script type="module">
    (async () => {
      const { hash } = new URL(location.href)
      const uncompleted = /(?:^|\.{2,3}|[\] (){},;<>!?:=^*+"`'#&|\/\\\-])$/

      const textarea = Object.assign(document.getElementsByTagName("textarea")[0], {
        placeholder: [
          '================================================',
          '| WARNING: Be sure to run only trusted sources |',
          '================================================',
          ' * `CTRL + Enter`: run in the current window',
          ' * `Ctrl + O`: Find docs for the expression at the cursor',
          ' * `Ctrl + I`: Find type at cursor',
          ' * `Alt + .`: Jump to definition',
          ' * `Alt + ,`: Jump back',
          ' * `Ctrl + Q`: Rename variable',
          ' * `Ctrl + .`: Select all occurrences of a variable'
        ].join('\n'),
        value: decodeURIComponent((hash ?? '').slice(1))
      })

      const editor = CodeMirror.fromTextArea(textarea, {
        autoCloseBrackets: true,
        autoRefresh: true,
        lineNumbers: true,
        mode: { name: "javascript", globalVars: true },
        scrollbarStyle: "overlay",
        theme: window.matchMedia("(prefers-color-scheme: dark)").matches ? "moxer" : "default"
      })

      editor.focus()

      function run(cm) {
        const src = encodeURIComponent(["/* ", Date.now(), " */ ", cm.getValue()].join(""))
        const { opener = window } = window
        const { document } = opener
        const script = document.createElement("script")

        document.body.append(Object.assign(script, {
          src: `data:text/javascript,${src}`,
          type: "module"
        }))

        script.remove()
      }

      const browser = await (await fetch("https://unpkg.com/tern@0.24.3/defs/browser.json")).json()
      const ecmascript = await (await fetch("https://unpkg.com/tern@0.24.3/defs/ecmascript.json")).json()
      const server = new CodeMirror.TernServer({
        defs: [ecmascript, browser],
        plugins: ['doc_comment', 'modules', 'es_modules'],
        responseFilter (doc, query, request, error, data) {
          const { list = [] } = CodeMirror.hint.javascript(editor) ?? {}
          const completions = (data.completions || []).map(({ name, type }) => ({ name, type }))
          const names = completions.map(({ name }) => name)

          list.forEach(name => {
            if (!names.includes(name)) {
              completions.push({ name, type: typeof window[name] })
            }
          })

          return {
            ...data,
            completions
          }
        }
      })

      editor.setOption("extraKeys", {
        "Ctrl-Enter": cm => run(cm),
        "Ctrl-I": cm => server.showType(cm),
        "Ctrl-O": cm => server.showDocs(cm),
        "Alt-.": cm => server.jumpToDef(cm),
        "Alt-,": cm => server.jumpBack(cm),
        "Ctrl-Q": cm => server.rename(cm),
        "Ctrl-.": cm => server.selectName(cm)
      })

      editor.on("cursorActivity", cm => server.updateArgHints(cm))

      editor.on("change", cm => {
        const script = cm.getValue()

        if (cm.state.completionActive) {
          return
        }

        const { line, ch } = cm.getCursor()
        const current = script.split('\n')[line]

        if (ch && !uncompleted.test(current.slice(0, ch))) {
          CodeMirror.commands.autocomplete(cm, server.getHint, { completeSingle: false })
        }
      })

      document.querySelector('.run').addEventListener('click', () => {
        run(editor)
      }, { passive: true })

      document.querySelector('.update').addEventListener('click', () => {
        location.hash = encodeURIComponent(editor.getValue())
      }, { passive: true })
    })()
  </script>
</head>
<body>
  <header>
    <button class="run">Run</button>
    <button class="update">Update location</button>
  </header>
  <textarea placeholder=" "></textarea>
</body>
</html>
